=begin
	Rakefile to compile, link and run the test harness
=end

WIRE_PATH="../wire-server"
C_FLAGS = "-I. -I../../unity-master/src -I#{WIRE_PATH}"

EXEC = "./bin/main.out"
LIB = "#{WIRE_PATH}/lib/wire.a"

task :default => [:build, :run]

heads = %w(context.h port_tests.h misc_tests.h)
fileroots = %w(main unity context port_tests misc_tests)

fileroots.each do |element|
    file "obj/#{element}.o" => heads + ["#{element}.c"] do
        puts "Compiling #{element}"
        system "cc #{C_FLAGS} -c #{element}.c -o obj/#{element}.o"
    end
end

objfiles = fileroots.map {|item| "obj/" + item + ".o"}

file "#{EXEC}" => objfiles do
	list = "cc -o #{EXEC} " +  objfiles.join(" ") + " #{LIB} -lpthread > /dev/null"
    system "#{list}"
end

desc "Compiles and links the test program"
task :build => "#{EXEC}" do
	puts "#{EXEC} is ready"
end

desc "Runs the test program"
task :run => :build do
	puts "Running tests"
	ret_val = system("#{EXEC}")
	fail unless ret_val #puts "ret #{ret_val}: #{$?.exitstatus}"
end

desc "Removes artefacts"
task :clean do 
	system "rm obj/* > /dev/null"
	system "rm bin/* > /dev/null"
end
